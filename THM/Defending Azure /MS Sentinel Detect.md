
# Introduction

We will move on to **threat detection and analytics**, given that we now have seen how to deploy Sentinel, connect data connectors, and how log data is available.

# What Are Analytics Rules

Once Microsoft Sentinel is ready for the organization and log data is being ingested, it is time to dig through all that data to **detect** security threats in the environment.

**Threat detection** in Microsoft Sentinel is made possible by **Analytics rules**.

Microsoft Sentinel security experts provide **analytics rule templates** based on:

- Known threats
- Common attack vectors
- Suspicious activity escalation chains

The alerts generated by Analytics rules create incidents that can then be assigned to and investigated by SOC analysts.

To recap, general Analytics rules flow and timeline are as follows:

- Microsoft Sentinel Analytics rules are the source of **alerts** and **incidents** triggered in your environment
- Using **Analytics rule templates**, specific rule templates are configured and enabled for your environment
- Once an analytics rule is **_enabled_**, based on the rule logic, it starts periodically monitoring the environment  
- Once an analytics rule is **_triggered_**, also with the help of AI-infused correlation, related _"alerts"_ are recorded and grouped into **_"incidents_**"
- These incidents are then triaged by (mostly) SOC Tier-1 analysts

**Do analytics rule templates need to be configured and enabled first in order to detect threats? (Yea/Nay)**
**A: Yea**

**Once "active" Analytics rules are triggered, what is generated in Microsoft Sentinel?**
**A: Alerts**

**Related alerts, with the help of the correlation engine, are recorded and grouped into what?**
**A: Incidents**

# Exploring Analytics Rules

Microsoft Sentinel Analytics plays an important part in the overall detection of security threats by **correlating** and **matching signals**. With a properly configured analytics rule, the following can be identified:

- Where an attack originated from
- What resources were compromised
- Potential data lost
- Timeline for the incident

## Security Analytics Use Cases

|   |
|---|
|Identification of compromised accounts|
|**User behaviour analysis -** to detect potentially suspicious patterns|
|**Network traffic analysis -** to locate trends indicating potential attacks|
|Detection of **Data exfiltration** by Attackers|
|Detection of **Insider threats**|
|Incident investigation and management|
|**Threat hunting**|
## Exploring Analytics Rules

![Microsoft Sentinel Analytics interface features a navigation pane on the left with options like Overview, Logs, News & Guides, Search, and threat management tools.Microsoft Sentinel Analytics interface features a navigation pane on the left with options like Overview, Logs, News & Guides, Search, and threat management tools.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737157510708.png)  

1. This is where you see the list of "**Active Rules**", "**Rule Templates**", and "**Anomalies**"
    - **Active Rules:** Rules that are enabled for your environment
    - **Rule Templates:** You can use templates to create an active rule. You need to go through the config wizard to enable the rule
    - **Anomalies:** Unusual behaviours of entities in an environment over a period of time
2. There are **attributes** you can filter the rules with:
    - **Rule Type:** Scheduled, NRT (Near-Real-Time), Fusion, Microsoft Security, ML Behavior Analytics, Threat Intelligence  
        
    - **Data Sources:** Data sources based on which the rule is working on  
        
    - **MITRE Tactics, Techniques**
3. Detailed description of the selected rule and data sources for it

## Rule Types

- **Checkboxes under "Rule type":** All, Scheduled, NRT, Fusion, Microsoft Security, ML Behavior Analytics, Threat Intelligence.
- **Scheduled Rules**
    - Most common rule type.
    - Require defining a specific timing schedule (e.g., every X days/hours/minutes).
    - Run at set intervals to detect patterns or anomalies.
- **Near-Real-Time (NRT) Rules**
    - Used for highly responsive detection scenarios.
    - Run every minute for near-immediate action.
- **Fusion Analytics**
    - Utilizes Microsoft Sentinel’s correlation engine with machine learning.
    - Detects advanced multistage attacks by correlating low-fidelity alerts and events into high-fidelity, actionable incidents.
    - Enabled by default.
- **ML Behavioral Analytics**
    - Based on proprietary Microsoft machine learning algorithms.
    - Internal logic is hidden.
    - Only one rule per template can be created.
- **Microsoft Defender Threat Intelligence (MDTI)**
    - Not customizable.
    - Automatically matches CEF logs, Syslog data, or Windows DNS events with threat indicators (domains, IPs, URLs) from Microsoft Threat Intelligence.
    - Generates high-fidelity alerts.

**Are active rules Analytics rules that are currently running and generating security alerts? (Yea/Nay)**
**A: Yea**

**How often do **Near-Real Time (NRT)** rules run?**
**A: Every Minute**

**Which rule type runs at regular intervals based on specified timing?**
**A: scheduled**

# Analytics Rule Wizard

`Microsoft Sentinel > Analytics > Rule templates > Select a rule template > Create rule`  

![Microsoft Sentinel Analytics shows a list of rule templates, with "User Assigned New Privileged Role" highlighted, marked as high severity and scheduled type.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737040774124.png)

**General**

![Analytics rule wizard - Create a new Scheduled rule' page in Microsoft Sentinel.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737569211672.png)

**Set Rule Logic**

!["Analytics rule wizard - Create a new Scheduled rule" page in Microsoft Sentinel, with the "Set rule logic" tab active. The "Rule query" section features a Kusto Query Language (KQL) query, and below it, a "Query scheduling" section allows users to set the execution frequency.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737156822967.png)

**Incident Settings**

Incident settings is where we can enable/disable incident creation from this rule and apply **alert grouping**.

 Analytics rules generate "alerts" when triggered, not incidents. Incidents are made up of alerts triggered by the rule.

We choose to generate incidents from alerts here, which can be assigned to and analyzed by SOC Tier-1 analysts.

![In Microsoft Sentinel's Analytics rule wizard, the 'Create incidents from alerts' option is enabled, while the 'Group related alerts into incidents' option is disabled.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737157138350.png)

**Automated Response**

This is where we can define the **automation options** (SOAR part of Microsoft Sentinel) as a response to the analytics rule getting triggered.

![In the "Analytics rule wizard - Create a new Scheduled rule" page in Microsoft Sentinel, the "Automated response" tab allows the addition of new automation rules.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737626145380.png)

When the automated response will be applied, are based on the following:

- When an **incident is created/updated**
- When an **alert is created**
![Create new automation rule interface with fields for "Automation rule name," "Trigger," and "Conditions." The "Trigger" dropdown shows options: "When incident is created," "When incident is updated," and "When alert is created."](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737040775359.png)

Finally, **automated response actions** are:

- To **run a playbook**
- To **change status/severity**
- To **assign an owner**
- To **add tags**
- To **add task**

![A dropdown menu titled 'Actions' with six options listed: 'Run playbook,' 'Change status,' 'Change severity,' 'Assign owner,' 'Add tags,' and 'Add task.'](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737626640816.png)

**What is used to customize Analytics rules templates?**
**A: Analytics rule wizard**

**In which part of the wizard can you configure how often the rule will run?**
**A: Query Scheduling**

**Which tab of the wizard serves as the SOAR side of Microsoft Sentinel?**
**A: Automated Response**

# Lab-04: Enable an Analytics Rule

**Context:** Your company recently deployed Microsoft Sentinel. A Data connector is populated and connected. You are tasked to enable an **analytics rule** to start threat detection.

**Role:** You are logged in as:

- Job function role: **Microsoft Sentinel Contributor**
- Log Analytics workspace permissions: **read** and **write**

## Enable an Analytics Rule

- Go to your **Microsoft Sentinel** dashboard and select the available workspace
- Under **Content management**, select **Content hub**
- Search for **Azure Activity** and install it
- Under **Configuration**, select **Analytics**
- Switch to the **Rule templates** tab

![In the "Create new automation rule" section of Microsoft Sentinel, the "Rule templates" tab is selected, with two other tabs: "Active rules" and "Anomalies."](https://tryhackme-images.s3.amazonaws.com/user-uploads/5efbaebdaaea011c857b438d/room-content/fe1f0b87f6c871bfd6389abc4d4c209f.png)

- Search for the "**rare subscription-level operations**" rule

![Rule templates in Microsoft Sentinel: Active rules, Rule templates, and Anomalies tabs are displayed, with "Rule templates" selected. A search bar shows "rare subscription-level," and there's an "Add filter" button.](https://tryhackme-images.s3.amazonaws.com/user-uploads/5efbaebdaaea011c857b438d/room-content/2ba61e59f638c0488c72abf4b657a074.png)

- Select the rule template and click "**Create rule**"

!["Create a new Scheduled rule" interface in Azure Sentinel, with the "General" tab and "Analytics rule details" section visible.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737153893152.png)

- Read the **rule description** for some background context
- Expand the **MITRE ATT&CK** drop-down to see how to map the rule to the different **MITRE Tactics and Techniques**

![List of stages in a cybersecurity attack lifecycle, each with a checkbox next to it. The stages include Reconnaissance, Resource Development, Initial Access, Execution, Persistence (checked), Privilege Escalation, Defense Evasion, Credential Access (checked), and Discovery.](https://tryhackme-images.s3.amazonaws.com/user-uploads/5efbaebdaaea011c857b438d/room-content/5efbaebdaaea011c857b438d-1725034477656.png)

- On the **Set rule logic** tab, read through the **Rule query**  
    - Note the **SensitiveOperationList** array values
    - Also, note that you can easily customize the rule query to your needs by simply modifying the **SensitiveOperationList** array values here

![The "Set rule logic" tab in the "Analytics rule wizard - Create a new Scheduled rule" screen in Azure Sentinel shows a KQL query for detecting rare subscription-level operations in Azure.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737043603703.png)

- The **test with current data** shows you a graphical simulation of the rule

![The "Results simulation" section in Azure Sentinel's "Analytics rule wizard" visualizes the last 50 evaluations of a defined analytics rule.](https://tryhackme-images.s3.amazonaws.com/user-uploads/5efbaebdaaea011c857b438d/room-content/5efbaebdaaea011c857b438d-1725034605704.png)

- Update the **Query scheduling** to the following:
    - Run query **every 1 hour**
    - Lookup data **from the last 7 days**

![query scheduling interface with two settings. The first setting is labeled "Run query every" with a value set to 1 and a dropdown menu set to "Hours."](https://tryhackme-images.s3.amazonaws.com/user-uploads/5efbaebdaaea011c857b438d/room-content/b7a13839bc5918708368fb7822a2e567.png)

- On the **Incident settings** tab:
    - Leave defaults so that **incidents are created** from alerts triggered by this rule.
    - Alert grouping can also be done here to **reduce the noise** from single alert

![The Azure Sentinel query scheduling interface has two sections: "Run query every," with a text box showing "1" and a dropdown set to "Hours."](https://tryhackme-images.s3.amazonaws.com/user-uploads/5efbaebdaaea011c857b438d/room-content/daf54ccd5dbbc30626fc392b415078c2.png)

- Select **Review + create** to save the rule
- Then, go back to the **Active** **Rules** tab, search for the newly created rule, select it, and click **Edit** on the sidebar

![Microsoft Sentinel Analytics interface, specifically focusing on the 'Active rules' section.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737572265667.png)

- Select the **Automated response** tab:
    - Add a **new automation rule**:
        - Rule Name: Tag Rule
        - Trigger: **When** **incident is created**
        - Actions: **Add tags**
            - Tag: subscription
        - Rule expiration: Leave as default
    - Click **Apply**

![The "Analytics rule wizard - Create a new Scheduled rule" interface in Azure Sentinel shows the "Automated response" tab on the left with an "Add new" button. The "Create new automation rule" window on the right includes fields for "Automation rule name," "Trigger," "Conditions," and "Actions." The "Trigger" is set to "When incident is created," and the action "Add tags" with the tag "subscription" is selected.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737043603905.png)

- Finally, **Review and Create** the rule

!["Review + create" tab in Microsoft Sentinel's Analytics rule wizard for the "Rare subscription-level operations in Azure," which detects sensitive subscription-level events in Azure Activity Logs.](https://tryhackme-images.s3.amazonaws.com/user-uploads/5efbaebdaaea011c857b438d/room-content/5efbaebdaaea011c857b438d-1725034904859.png)

## Review the Enabled Analytics Rule

- Switch to the **Active rules** tab
- Select the recently saved rule - **Rare subscription-level operations in Azure**
- On the right pane, review the **rule details**, and scroll down to see your settings for:  
    - **Rule frequency**
    - **Rule period**

![Configuration of an Azure alert for monitoring rare subscription-level operations. The alert is set to a low severity level, with the content hub as the data source and the status enabled.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6601e243753b8d484668851e/room-content/6601e243753b8d484668851e-1737627196962.png)

- Click **Compare with template** to see the differences between your settings and the rule template in YAML representation

![The 'Analytics rule wizard - Edit Scheduled rule' interface in Azure shows a side-by-side comparison of the YAML for the existing rule (version 2.0.3) and the latest template, highlighting differences in query frequency, period, and entity mappings.](https://tryhackme-images.s3.amazonaws.com/user-uploads/5efbaebdaaea011c857b438d/room-content/3c57adfd153e449a39696cc7b3f15908.png)
